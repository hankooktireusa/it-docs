---
layout: default
title: 📑 장애 조치 배포
permalink: /ko/web/proposals/failover-deployments/
---

<link rel="stylesheet" href="{{ '/assets/css/custom.css' | relative_url }}">
{% include lang-toggle.html %}

<h1>📑 장애 조치 배포</h1>
<p>가중치 기반 ALB 대상 그룹 라우팅을 사용하여 prod1↔prod2 간 무중단 전환을 가능하게 합니다.</p>

<hr />

<h2>🎯 목표</h2>
<ul>
  <li>배포 중에는 <strong>prod1</strong>에 100% 트래픽을 전송하고 <strong>prod2</strong>는 비활성 상태로 둡니다.</li>
  <li>검증 후 <strong>prod2</strong>로 트래픽을 점진적으로 전환 (예: 10% → 25% → 50% → 100%).</li>
  <li>다음 배포 주기에서는 역할을 전환 (prod2 활성, prod1 배포).</li>
  <li>검증 후 균등 분배로 복귀.</li>
  <li>ALB에서 Listener 전달 동작을 <strong>가중치 대상 그룹</strong>으로 변환하여 수행.</li>
</ul>

<hr />

<details>
  <summary>🛠 단계별 계획 (AWS 콘솔)</summary>
  <div>

    <h3>1) 현재 Listener 규칙 확인</h3>
    <ul>
      <li>AWS 콘솔 → <strong>EC2 → 로드 밸런서</strong></li>
      <li><strong>ALB</strong> 선택 → <strong>리스너</strong> 탭 → <strong>:443</strong> 클릭</li>
      <li>호스트/경로에 맞는 규칙을 확인 → <code>-web-tg</code> 또는 <code>-portal-tg</code>로 전달되는지 확인</li>
    </ul>

    <hr />

    <h3>2) 고정 규칙 → 가중치 대상 그룹으로 변환</h3>
    <p><strong>목표:</strong> 조정 가능한 가중치로 prod1 및 prod2 대상 그룹 모두로 전달.</p>

    <p><strong>예시 대상 그룹:</strong></p>
    <ul>
      <li><code>hankooktire-us-prd-&lt;web|portal&gt;-01-tg</code> (prod1)</li>
      <li><code>hankooktire-us-prd-&lt;web|portal&gt;-02-tg</code> (prod2)</li>
    </ul>

    <p><strong>방법:</strong></p>
    <ol>
      <li>규칙 수정.</li>
      <li><strong>Forward to → Weighted target groups</strong> 선택.</li>
      <li>두 TG를 추가하고 초기 가중치 설정:
        <ul>
          <li><code>...-01-tg</code> → <strong>100</strong></li>
          <li><code>...-02-tg</code> → <strong>0</strong></li>
        </ul>
      </li>
      <li>저장.</li>
    </ol>

    <hr />

    <h3>3) prod1에서 100% 확인</h3>
    <ul>
      <li>모든 HTTPS 트래픽이 <strong>prod1</strong>으로 가야 합니다.</li>
      <li><strong>prod2</strong>는 비활성 상태로 배포 준비 완료.</li>
      <li><code>...-02-tg</code> 인스턴스에 배포.</li>
    </ul>

    <hr />

    <h3>4) prod2로 점진적 전환</h3>
    <ol>
      <li>리스너 규칙으로 돌아갑니다.</li>
      <li>단계별로 가중치를 조정하고 각 단계에서 테스트:
        <ul>
          <li>90/10 → 75/25 → 50/50 → 25/75 → 0/100 (또는 원하는 단계)</li>
        </ul>
      </li>
      <li>각 단계에서 앱 동작 검증.</li>
      <li><strong>CloudWatch</strong> 메트릭(TG 상태, 지연, 4xx/5xx) 모니터링.</li>
    </ol>

    <hr />

    <h3>5) 다음 배포 시 역할 전환</h3>
    <ol>
      <li><strong>prod1 TG</strong> 가중치를 <strong>0</strong>으로 설정.</li>
      <li>배포.</li>
      <li><strong>100</strong>으로 다시 올림.</li>
      <li>모니터링, 테스트, 마무리.</li>
    </ol>

  </div>
</details>

<hr />

<details>
  <summary>📌 참고 사항</summary>
  <div>
    <ul>
      <li>추가 AWS 서비스나 비용 변경 없음.</li>
      <li>무중단 방식: 가중치 <code>0</code>은 <strong>새로운</strong> 연결을 중단하지만 기존 연결은 완료시킴.</li>
      <li>TG 스티키 세션은 <strong>비활성</strong> 상태라 전환 시 세션이 이전 TG에 남지 않음.</li>
      <li>전체 배포 프로세스에는 변경 없음.</li>
      <li>장애 조치 배포 시 팀과 반드시 협의.</li>
      <li><strong>Dev ALB</strong>는 현재 이 구성을 반영하지 않음:
        <ul>
          <li>모범 사례: <strong>dev</strong> 환경에 가중치 규칙을 복제해 먼저 시험.</li>
        </ul>
      </li>
    </ul>
  </div>
</details>
